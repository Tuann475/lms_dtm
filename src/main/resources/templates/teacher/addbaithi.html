<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Remove invalid /admin/css/style.css; add teacher style for colors -->
    <link rel="stylesheet" href="/teacher/css/style.css">
    <!-- Remove duplicate font-awesome includes; keep one latest -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <!-- Teacher main layout script providing injectTeacherLayout() -->
    <script src="/teacher/js/main.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.2/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.2/js/dataTables.bootstrap5.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.2/js/toastr.min.js"></script>

    <script src="js/menu.js"></script>
    <script src="js/course.js"></script>
    <script src="js/category.js"></script>
    <script src="js/exam.js"></script>
    <script src="/js/teacher_exam_manage.js"></script>
    <script>
        window.onload = function () {
            // If URL has id, load existing exam; else load course/category
            const id = new URL(document.URL).searchParams.get('id');
            if (id) {
                loadTeacherExam();
            } else {
                loadCourseSelectTeacher();
                loadCategoriesLesson();
            }
        };
    </script>
    <style>
        /* Center ONLY the textarea blocks; keep other inputs left-aligned */
        #thembonhomodal #wrapEditorNew,
        #suaphanthi #wrapEditorUpdate {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #thembonhomodal #wrapEditorNew textarea,
        #suaphanthi #wrapEditorUpdate textarea {
            max-width: 700px;
            width: 100%;
            text-align: center;
            min-height: 180px;
        }

        /* Remove previous centering effect on other columns (override) */
        #thembonhomodal .modal-body .col-sm-6,
        #thembonhomodal .modal-body .col-sm-4,
        #thembonhomodal .modal-body .col-sm-8,
        #suaphanthi .modal-body .col-sm-6,
        #suaphanthi .modal-body .col-sm-4,
        #suaphanthi .modal-body .col-sm-8 {
            align-items: flex-start !important;
        }
        /* Prevent table overlapping nav: navfit script will adjust margin-left dynamically */
        .listmenumain a { display:block; white-space:nowrap; padding:6px 10px; }
        .col-course { max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #examTable { table-layout:fixed; }
        #examTable td .course-text { display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        /* Match action buttons font size to other columns */
        .col-actions .btn { font-size:inherit; line-height:1.5; }
        /* Align with baithi.html layout */
        .navleft { width:250px; padding:8px 10px; }
        .contentweb { margin-left:250px; }
        .noidunglesson { white-space:normal; overflow-wrap:anywhere; word-break:break-word; max-width:100%; max-height:160px; overflow:auto; line-height:1.4; }
        .skill-badge { font-size:11px; }
        .singlebonho { background:#bdbdbd; padding:4px 10px; border-radius:5px; position:relative; margin-top:5px; }
        .iconxoabn { position:absolute; right:5px; top:50%; transform:translateY(-50%); color:red; cursor:pointer; text-align:center; margin:0 auto; }
        .iconedit { position:absolute; right:35px; top:50%; transform:translateY(-50%); cursor:pointer; text-align:center; margin:0 auto; }
        .lbadd { font-weight: bold; }
        .col-sm-12 > h4:first-child {
            margin-top: 8px;
            margin-bottom: 8px;
        }
        main.contentmain {
            padding-top: 32px;
        }
        main.contentmain hr {
            margin-top: 8px;
            margin-bottom: 12px;
        }
    </style>
    <title>Quản lý bài thi</title>
</head>

<body class="sb-nav-fixed">
<div id="navleft" class="navleft"></div>
<div class="contentweb">
    <div id="headerweb" class="headerweb"></div>
    <main class="contentmain row">
        <div class="col-sm-12">
            <h4>Thông tin bài thi</h4>
            <hr>
        </div>
        <div class="col-sm-3">
            <label class="lbadd" for="tenbaithi">Tên bài thi <span style="color: red;">*</span></label>
            <input id="tenbaithi" class="form-control" required>
            <div id="error-tenbaithi" class="text-danger" style="display: none;">Tên bài thi không được để trống.
            </div>
        </div>
        <div class="col-sm-3">
            <label class="lbadd" for="limittime">Thời gian giới hạn (phút) <span style="color: red;">*</span></label>
            <input id="limittime" type="number" value="40" class="form-control" required>
            <div id="error-limittime" class="text-danger" style="display: none;">Thời gian giới hạn phải lớn hơn
                0.
            </div>
        </div>
        <div class="col-sm-3">
            <label class="lbadd" for="ngaythi">Ngày thi <span style="color: red;">*</span></label>
            <input id="ngaythi" type="date" class="form-control" required>
            <div id="error-ngaythi" class="text-danger" style="display: none;">Ngày thi không được để trống.</div>
        </div>
        <div class="col-sm-3">
            <label class="lbadd" for="giothi">Giờ thi <span style="color: red;">*</span></label>
            <input id="giothi" type="time" class="form-control" required>
            <div id="error-giothi" class="text-danger" style="display: none;">Giờ thi không được để trống.</div>
        </div>
        <div class="col-sm-12">
            <label class="lbadd" for="khoahocbaithi">Khóa học <span style="color: red;">*</span></label>
            <select id="khoahocbaithi" class="form-control" required>
                <option value=""></option>
            </select>
            <div id="error-khoahoc" class="text-danger" style="display: none;">Khóa học không được để trống.</div>
        </div>
        <div class="col-sm-12">
            <h4 class="lbtieude">Thông tin phần thi</h4>
            <hr>
            <div id="listbonho">
                <div id="listphanthidathem"></div>
                <div id="listphanthitam"></div>
            </div>
            <div class="btn-add-phanthi-wrapper" style="display:flex; justify-content:center; margin-top:32px;">
                <button data-bs-toggle="modal" data-bs-target="#thembonhomodal" class="btn btn-success btnthemhinhanh">
                    <i class="fa fa-plus"></i> Thêm phần thi <span style="color: red;">*</span>
                </button>
            </div>
            <div id="error-phanthi" class="text-danger" style="display: none;">Vui lòng thêm 1 phần thi ấn vào +Thêm phần thi
            </div>
        </div>
        <div class="col-sm-12" style="padding-top: 20px;">
            <button onclick="saveExam()" class="btn btn-success form-control" id="btnthemdethi"><i
                    class="fa fa-plus"></i> Thêm đề thi
            </button>
        </div>
    </main>

    <!-- Password modal placeholder for teacher layout injection -->
    <div id="divdoimk"></div>
</div>
<!-- Modals moved inside body -->
<div class="modal fade" id="thembonhomodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm phần thi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row">
                <div class="col-sm-6">
                    <label class="lbadd" for="tenphanthi">Tên phần thi <span style="color: red;">*</span></label>
                    <input id="tenphanthi" class="form-control">
                </div>
                <div class="col-sm-6">
                    <label class="lbadd" for="danhmucphanthi">Danh mục <span style="color: red;">*</span></label>
                    <select id="danhmucphanthi" class="form-control"></select>
                </div>
                <div class="col-sm-6">
                    <label class="lbadd" for="kynang">Kỹ năng <span style="color: red;">*</span></label>
                    <select id="kynang" class="form-control">
                        <option value="LISTENING">LISTENING</option>
                        <option value="SPEAKING">SPEAKING</option>
                        <option value="READING">READING</option>
                        <option value="WRITING">WRITING</option>
                    </select>
                </div>
                <label class="lbadd" for="editor">Nội dung: </label>
                <div class="col-sm-4" id="wrapFileNew"><input type="file" accept="audio/*,video/mp4" class="form-control" id="chonfilennghe"></div>
                <div class="col-sm-8" id="wrapEditorNew"><textarea id="editor" name="content"></textarea></div>
                <div class="col-sm-12" style="padding-bottom: 20px;">
                    <div id="loading">
                        <div class="bar1 bar"></div>
                    </div>
                </div>
                <div class="col-sm-12">
                    <button onclick="addPhanThi()" class="form-control btn btn-primary">Thêm phần thi</button>
                </div>
            </div>
        </div>

    </div>
</div>


<div class="modal fade" id="suaphanthi" tabindex="-1" aria-labelledby="exampleModalLabelUpdate" aria-hidden="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabelUpdate">Cập nhật thông tin phần thi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row">
                <div class="col-sm-6">
                    <label class="lbadd" for="tenphanthiupdate">Tên phần thi <span style="color: red;">*</span></label>
                    <input id="idlesson" type="hidden" class="form-control">
                    <input id="tenphanthiupdate" class="form-control">
                </div>
                <div class="col-sm-6">
                    <label class="lbadd" for="danhmucphanthiupdate">Danh mục <span style="color: red;">*</span></label>
                    <select id="danhmucphanthiupdate" class="form-control"></select>
                </div>
                <div class="col-sm-6">
                    <label class="lbadd" for="kynangupdate">Kỹ năng <span style="color: red;">*</span></label>
                    <select id="kynangupdate" class="form-control">
                        <option value="LISTENING">LISTENING</option>
                        <option value="SPEAKING">SPEAKING</option>
                        <option value="READING">READING</option>
                        <option value="WRITING">WRITING</option>
                    </select>
                </div>

                <label class="lbadd" for="editorupdate">Nội dung</label>
                <div class="col-sm-4" id="wrapFileUpdate"><input type="file" accept="audio/*,video/mp4" class="form-control" id="chonfilenngheupdate"></div>
                <div class="col-sm-8" id="wrapEditorUpdate">
                    <div id="filePreviewUpdate" style="display:none; text-align:center; margin-bottom:10px;"></div>
                    <textarea id="editorupdate" name="content"></textarea>
                </div>
                <div class="col-sm-12" style="padding-bottom: 20px;">
                    <div id="loadingupdate">
                        <div class="bar1 bar"></div>
                    </div>
                </div>
                <div class="col-sm-12">
                    <button onclick="updateLessonBasicModal()" class="form-control btn btn-primary">Cập nhật phần thi</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.tiny.cloud/1/7br94foebz2vsbp8z12edwjxpzrnmunjnufe50p006hsvags/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>
<script>
    tinymce.init({
        selector: 'textarea#editor'
    });
    tinymce.init({
        selector: 'textarea#editorupdate'
    });
</script>
<script>
  function applySkillLayout(selectId, fileWrapperId, editorWrapperId){
    var skill = document.getElementById(selectId).value;
    var fileWrap = document.getElementById(fileWrapperId);
    var editorWrap = document.getElementById(editorWrapperId);
    if(skill === 'LISTENING'){
        // LISTENING: show file + content
        fileWrap.style.display='block';
        editorWrap.style.display='block';
    } else if(skill === 'SPEAKING'){
        // SPEAKING: hide file per requirement, only show content (prompt / gợi ý)
        fileWrap.style.display='none';
        editorWrap.style.display='block';
    } else { // READING / WRITING
        fileWrap.style.display='none';
        editorWrap.style.display='block';
    }
  }
  document.addEventListener('DOMContentLoaded', function(){
    applySkillLayout('kynang','wrapFileNew','wrapEditorNew');
    applySkillLayout('kynangupdate','wrapFileUpdate','wrapEditorUpdate');
    document.getElementById('kynang').addEventListener('change', function(){
        applySkillLayout('kynang','wrapFileNew','wrapEditorNew');
    });
    document.getElementById('kynangupdate').addEventListener('change', function(){
        applySkillLayout('kynangupdate','wrapFileUpdate','wrapEditorUpdate');
        if(typeof renderFilePreview === 'function'){
            // lessonLink defined in exam.js
            renderFilePreview(this.value, lessonLink);
        }
    });
    var fileUpdate = document.getElementById('chonfilenngheupdate');
    if(fileUpdate){
        fileUpdate.addEventListener('change', function(){
            if(this.files && this.files.length>0){
                var tempUrl = URL.createObjectURL(this.files[0]);
                var skill = document.getElementById('kynangupdate').value;
                if(typeof renderFilePreview === 'function'){
                    renderFilePreview(skill, tempUrl);
                }
            } else if(typeof renderFilePreview === 'function') {
                renderFilePreview(document.getElementById('kynangupdate').value, lessonLink);
            }
        });
    }
  });
</script>
<script>
// Single unified ensureTeacherLayout fallback
(function(){
  function ensureTeacherLayout(){
    if(typeof injectTeacherLayout === 'function'){
      var nav = document.getElementById('navleft');
      var header = document.getElementById('headerweb');
      if((nav && nav.innerHTML.trim()==='') || (header && header.innerHTML.trim()==='')){
        injectTeacherLayout();
      }
    }
  }
  document.addEventListener('DOMContentLoaded', ensureTeacherLayout);
  setTimeout(ensureTeacherLayout,300);
  document.addEventListener('visibilitychange', function(){ if(!document.hidden){ ensureTeacherLayout(); } });
})();
</script>
</body>
</html>
