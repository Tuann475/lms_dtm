<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <title>Kết quả bài thi & Ôn luyện</title>
    <link href="css/styles.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"
          integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.2/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.2/js/dataTables.bootstrap5.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.2/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.2/js/toastr.min.js"></script>
    <script src="js/menu.js"></script>
    <!-- Load admin result.js to enable history rendering and grading modals -->
    <script src="/admin/js/result.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        window.onload = function () {
            loadResult();
        }

        function sanitizeAdmin(s){ return (s||'').replace(/</g,'&lt;'); }
        function isFillAdmin(item){
            const qt = item?.questionType ?? item?.question?.type ?? item?.question?.questionType;
            return qt && (qt.toUpperCase()==='FILL' || qt.toUpperCase()==='INPUT' || qt.toUpperCase()==='SHORT_ANSWER');
        }
        function getAdminAnswerText(item){
            // Prefer explicit text input
            if(item && item.answerText!=null){ return item.answerText; }
            // MCQ selected option text/title
            if(item && item.answer){
                const opt = item.answer.content ?? item.answer.title ?? item.answerText;
                if(opt!=null){ return opt; }
            }
            // Fallback
            return item?.userAnswer ?? null;
        }
        function renderAdminAnswer(item){
            const a = getAdminAnswerText(item);
            if(a==null || (''+a).trim().length===0){
                return '<span class="badge bg-warning text-dark">Chưa trả lời</span>';
            }
            return sanitizeAdmin(a);
        }
        function getQuestionContent(item){
            return item?.questionContent ?? item?.question?.content ?? item?.questionText ?? null;
        }
        function getOptionsHtml(item){
            const opts = item?.options ?? item?.answers ?? item?.question?.answers;
            if(!Array.isArray(opts) || opts.length===0) return '';
            let html = '<ul class="small mb-2 ps-3">';
            opts.forEach(o=>{
                const txt = sanitizeAdmin(o?.content ?? o?.title ?? '');
                const isCorrect = o?.isTrue === true;
                html += `<li>${txt}${isCorrect? ' <span class="badge bg-success">Đúng</span>':''}</li>`;
            });
            html += '</ul>';
            return html;
        }

        async function loadBlobAudioToPlayer(audioEl){
            try {
                let src = audioEl?.dataset?.audioSrc;
                const idFallback = audioEl?.dataset?.fallbackAudioId;
                if(!src){
                    if(idFallback){
                        src = '/api/speaking/audio/' + idFallback;
                        audioEl.dataset.audioSrc = src;
                    } else { return; }
                }
                const isAbsolute = /^https?:\/\//i.test(src);
                const isSameOriginRelative = !isAbsolute && src.startsWith('/');
                let fetched = false;
                if (isSameOriginRelative || src.startsWith('/api/')) {
                    try {
                        const resp = await fetch(src, { headers: authHeaders(), credentials: 'include' });
                        if(resp.ok){
                            const blob = await resp.blob();
                            audioEl.src = URL.createObjectURL(blob);
                            audioEl.load();
                            fetched = true;
                        } else {
                            console.warn('Audio fetch non-OK', src, resp.status);
                        }
                    } catch(err) {
                        console.warn('Audio fetch error', src, err);
                    }
                }
                if(!fetched){
                    // Fallback: if we have an idFallback and src didn't work & src not already fallback, try fallback endpoint
                    if(idFallback && !src.includes('/api/speaking/audio/')){
                        const fb = '/api/speaking/audio/' + idFallback;
                        try {
                            const resp2 = await fetch(fb, { headers: authHeaders(), credentials: 'include' });
                            if(resp2.ok){
                                const blob2 = await resp2.blob();
                                audioEl.src = URL.createObjectURL(blob2);
                                audioEl.load();
                                fetched = true;
                                console.log('Loaded via fallback speaking audio endpoint', fb);
                            }
                        } catch(e2){ console.warn('Fallback audio fetch failed', fb, e2); }
                        if(!fetched){
                            // last resort direct assignment of original src
                            audioEl.src = src;
                            audioEl.load();
                        }
                    } else {
                        audioEl.src = src;
                        audioEl.load();
                    }
                }
            } catch(e) { console.warn('loadBlobAudioToPlayer outer error', e); }
        }
        async function initPromptAudios(containerId){
            const container = document.getElementById(containerId);
            if(!container) return;
            const players = container.querySelectorAll('audio[data-audio-src]');
            for(const p of players){ await loadBlobAudioToPlayer(p); }
        }

        function openSkillModal(resultId, skill) {
            const modalId = skill.toLowerCase() + "Modal";
            const listId = skill.toLowerCase() + "List";
            const modalEl = new bootstrap.Modal(document.getElementById(modalId));
            document.getElementById(listId).innerHTML = '<p class="text-muted">Đang tải...</p>';
            fetch('/api/result/admin/skill-pending?resultId=' + resultId + '&skill=' + skill, {
                headers: authHeaders()
            }).then(r => r.ok ? r.json() : Promise.reject(r)).then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    document.getElementById(listId).innerHTML = '<p class="text-muted">Không có bài cần chấm.</p>';
                    return;
                }
                let html = '';
                data.forEach(item => {
                    const isFill = isFillAdmin(item);
                    const typeBadge = isFill ? " <span class='badge bg-info text-dark'>Nhập vào ô trống</span>" : '';
                    let media='';
                    if (skill === 'SPEAKING') {
                        let promptAudio = item?.linkAudio
                            || item?.questionLinkAudio
                            || item?.question?.linkAudio
                            || item?.question?.link_audio
                            || null;
                        promptAudio = normalizeAudioSrc(promptAudio);
                        let rawQuestionLinkAudio = item?.question?.link_audio || item?.question?.linkAudio || '';
                        const effectiveSrc = promptAudio || ('/api/speaking/audio/' + item.id);
                        const studentAudioSrcRaw = (item?.userAudio || item?.speakingAudio || item?.answerText || '');
                        const studentAudioSrc = normalizeAudioSrc(studentAudioSrcRaw);
                        const hasStudentAudio = !!studentAudioSrc && (''+studentAudioSrc).trim().length>0;
                        const attemptsHtml = (item?.speakingAttempts && item.speakingAttempts>0) ? `<span class='badge bg-info ms-2'>Lần nộp: ${item.speakingAttempts}</span>` : '';
                        media += "<div class='d-flex flex-column gap-2 mb-2'>";
                        media += `<div><small class='text-muted'>Audio đề:</small>
                                   <div class='small text-muted mt-1'>link_audio: ${rawQuestionLinkAudio? `<a href='${promptAudio}' target='_blank' rel='noopener'>${rawQuestionLinkAudio.replace(/</g,'&lt;')}</a>` : '<em>Không có trường link_audio</em>'}</div>
                                   <audio controls class='mt-1' data-audio-src='${effectiveSrc}' data-fallback-audio-id='${item.id}'></audio>
                                   <div class='small text-danger d-none' id='promptAudioErr_${item.id}'>Không tải được audio đề.</div>
                               </div>`;
                        media += `<div class='mt-2'><small class='text-muted'>Audio học viên:</small>
                                   ${hasStudentAudio ? `<audio controls class='mt-1' data-audio-src='${studentAudioSrc}'></audio>` : `<div class='small fst-italic text-muted'>Chưa có audio học viên</div>`}
                                   ${attemptsHtml}
                               </div>`;
                        media += "</div>";
                    } else if (skill === 'LISTENING') {
                        media = `<div class='small fst-italic'>Không có media</div>`;
                    } else {
                        media = `<div class='small fst-italic'>Không có media</div>`;
                    }
                    const qContent = getQuestionContent(item);
                    const optsHtml = isFill ? '' : getOptionsHtml(item);
                    html += `<div class='border rounded p-2 mb-2'>
                        <div class='small text-secondary'>Câu hỏi #${item.questionId || ''}</div>
                        <p class='mb-1'>${sanitizeAdmin(item.questionTitle || '')}${typeBadge}</p>
                        ${qContent? `<div class='noidunglesson'>${sanitizeAdmin(qContent)}</div>`:''}
                        ${optsHtml}
                        ${media}
                        <div class='mt-2'><strong>Đáp án đã làm:</strong> ${renderAdminAnswer(item)}</div>
                        <div class='mt-2 d-flex gap-2 align-items-center'>
                            <input type='number' min='0' max='9' step='1' class='form-control form-control-sm w-auto' id='score_${skill}_${item.id}' placeholder='Điểm'>
                            <input type='text' class='form-control form-control-sm' id='fb_${skill}_${item.id}' placeholder='Nhận xét'>
                           ${isFill ? `<input type='text' class='form-control form-control-sm' id='ans_${skill}_${item.id}' placeholder='Đáp án nhập vào ô trống' value='${item.userAnswer ?? ''}'>` : ''}
                            <button class='btn btn-sm btn-primary' onclick='gradeSkill("${skill}", ${item.id}, ${isFill ? 'true' : 'false'})'>Lưu</button>
                            <button class='btn btn-sm btn-outline-secondary' onclick='openHistory("${skill}", ${item.id})'>Lịch sử</button>
                        </div>
                    </div>`;
                });
                document.getElementById(listId).innerHTML = html;
                initPromptAudios(listId);
                // Attach status listeners for student audio after src loaded
                setTimeout(()=>{
                    data.forEach(item=>{
                        const promptEl = document.querySelector(`audio[data-audio-src][src='']`) || document.querySelector(`audio[data-audio-src][data-audio-src='${normalizeAudioSrc(item?.linkAudio)||normalizeAudioSrc(item?.questionLinkAudio)||normalizeAudioSrc(item?.question?.linkAudio)||normalizeAudioSrc(item?.question?.link_audio)||('/api/speaking/audio/'+item.id)}']`);
                        const promptErr = document.getElementById('promptAudioErr_'+item.id);
                        if(promptEl){
                            promptEl.addEventListener('error', ()=>{ if(promptErr){ promptErr.classList.remove('d-none'); } });
                        }
                    });
                }, 300);
            }).catch(err => {
                document.getElementById(listId).innerHTML = '<p class="text-danger">Lỗi tải dữ liệu</p>';
            });
            const modalNode = document.getElementById(modalId);
            if (modalNode) {
                const modal = new bootstrap.Modal(modalNode);
                modal.show();
            }
        }

        function gradeSkill(skill, id, isFill) {
            const scoreEl = document.getElementById('score_' + skill + '_' + id);
            const fbEl = document.getElementById('fb_' + skill + '_' + id);
            const score = scoreEl && scoreEl.value ? scoreEl.value : '';
            const fb = fbEl && fbEl.value ? fbEl.value.trim() : '';
            let ans = '';
            if (isFill) {
                const ansEl = document.getElementById('ans_' + skill + '_' + id);
                ans = ansEl && ansEl.value ? ansEl.value.trim() : '';
            }
            if (score === '') {
                toastr.warning('Nhập điểm');
                return;
            }
            let url = '/api/result/admin/skill/grade?id=' + id + '&score=' + score + '&skill=' + skill + '&feedback=' + encodeURIComponent(fb);
            if (isFill) url += '&userAnswer=' + encodeURIComponent(ans);
            fetch(url, {
                method: 'POST', headers: authHeaders()
            }).then(r => r.ok ? r.json() : Promise.reject(r)).then(_ => {
                toastr.success('Đã lưu');
                scoreEl.value = ''; fbEl.value = '';
                if (isFill) { const ansEl = document.getElementById('ans_' + skill + '_' + id); if (ansEl) ansEl.value = ''; }
            }).catch(_ => toastr.error('Lưu thất bại'));
        }

        function authHeaders() {
            const t = localStorage.getItem('token') || sessionStorage.getItem('token');
            return {'Authorization': 'Bearer ' + t};
        }

        function normalizeAudioSrc(src){
            if(!src) return src;
            const trimmed = src.trim();
            if(/^https?:\/\//i.test(trimmed)) return trimmed; // absolute
            // if already starts with '/', keep
            if(trimmed.startsWith('/')) return trimmed;
            // ensure root-relative (avoid /admin/ prefixing issues)
            return '/' + trimmed.replace(/^\/+/, '');
        }

        // Ẩn các bài viết chờ chấm trong modal Writing
        function hidePendingWriting() {
            const writingPendingTab = document.querySelector('a[href="#writingPending"]');
            if (writingPendingTab) {
                writingPendingTab.addEventListener('click', function () {
                    setTimeout(() => {
                        const pendingItems = document.querySelectorAll('#writingListPending .border');
                        pendingItems.forEach(item => {
                            const scoreEl = item.querySelector('input[id^="score_"]');
                            if (scoreEl && scoreEl.value === '') {
                                item.style.display = 'none';
                            }
                        });
                    }, 100);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            hidePendingWriting();
        });
    </script>
</head>

<body class="sb-nav-fixed">
<nav id="top" class="sb-topnav navbar navbar-expand navbar-dark bg-dark"></nav>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav"></div>
    <div id="layoutSidenav_content">
        <main class="main">
            <div class="col-sm-12 header-sp">
            </div>
            <div class="col-sm-12">
                <div class="wrapper">

                    <button id="exportExcel" class="btn btn-success mb-2">Xuất Excel</button>
                    <table id="example" class="table table-striped tablefix">
                        <thead class="thead-tablefix">
                        <tr>
                            <th>Học viên</th>
                            <th>Tổng câu</th>
                            <th>Sai</th>
                            <th>Đúng</th>
                            <th>Kết quả đạt</th>
                            <th>Chấm</th>
                        </tr>
                        </thead>
                        <tbody id="listresult">
                        <!-- Rows appended by result.js with multiple skill buttons -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="writingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chấm bài Writing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#writingAll" role="tab">Tất cả</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#writingPending" role="tab">Chờ chấm</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#writingGraded" role="tab">Đã chấm</a></li>
        </ul>
        <div class="tab-content mt-2">
          <div class="tab-pane fade show active" id="writingAll" role="tabpanel"><div id="writingListAll"></div></div>
          <div class="tab-pane fade" id="writingPending" role="tabpanel"><div id="writingListPending"></div></div>
          <div class="tab-pane fade" id="writingGraded" role="tabpanel"><div id="writingListGraded"></div></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="speakingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chấm Speaking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#speakingAll" role="tab">Tất cả</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#speakingPending" role="tab">Chờ chấm</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#speakingGraded" role="tab">Đã chấm</a></li>
        </ul>
        <div class="tab-content mt-2">
          <div class="tab-pane fade show active" id="speakingAll" role="tabpanel"><div id="speakingListAll"></div></div>
          <div class="tab-pane fade" id="speakingPending" role="tabpanel"><div id="speakingListPending"></div></div>
          <div class="tab-pane fade" id="speakingGraded" role="tabpanel"><div id="speakingListGraded"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="readingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chấm Reading</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#readingAll" role="tab">Tất cả</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#readingPending" role="tab">Chờ chấm</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#readingGraded" role="tab">Đã chấm</a></li>
        </ul>
        <div class="tab-content mt-2">
          <div class="tab-pane fade show active" id="readingAll" role="tabpanel"><div id="readingListAll"></div></div>
          <div class="tab-pane fade" id="readingPending" role="tabpanel"><div id="readingListPending"></div></div>
          <div class="tab-pane fade" id="readingGraded" role="tabpanel"><div id="readingListGraded"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="listeningModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chấm Listening</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#listeningAll" role="tab">Tất cả</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#listeningPending" role="tab">Chờ chấm</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#listeningGraded" role="tab">Đã chấm</a></li>
        </ul>
        <div class="tab-content mt-2">
          <div class="tab-pane fade show active" id="listeningAll" role="tabpanel"><div id="listeningListAll"></div></div>
          <div class="tab-pane fade" id="listeningPending" role="tabpanel"><div id="listeningListPending"></div></div>
          <div class="tab-pane fade" id="listeningGraded" role="tabpanel"><div id="listeningListGraded"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historyTitle">Lịch sử chấm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="historyBody"></div>
    </div>
  </div>
</div>
</body>
<script>
    // Xuất dữ liệu sang Excel
    document.getElementById("exportExcel").addEventListener("click", function () {
        var table = document.getElementById("example"); // Lấy bảng HTML
        var wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"}); // Chuyển đổi bảng sang workbook
        XLSX.writeFile(wb, "Kết quả thi.xlsx"); // Lưu file Excel
    });

</script>

<script>
    $('#example').DataTable()
</script>

</html>
